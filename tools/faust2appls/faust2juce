#! /bin/bash -e

#####################################################################
#                                                                   #
#               Compiles Faust programs to core Juce                #
#               (c) Grame, 2016                                     #
#                                                                   #
#####################################################################

. faustpath
. faustoptflags
CXXFLAGS=$MYGCCFLAGS

ARCHFILESTANDALONE="juce-standalone.cpp"
ARCHFILEPLUGIN="juce-plugin.cpp"

PATH=$PATH:/usr/local/bin
DEBUG=false


#-------------------------------------------------------------------
# Analyze command arguments :
# faust options                 -> OPTIONS
# if -omp : -openmp or -fopenmp -> OPENMP
# existing *.dsp files          -> FILES
#

# PHASE 1 : Look for -icc option to force use of intel icc (actually icpc)
# without having to configure CXX and CXXFLAGS
for p in $@; do
	if [ "$p" = -icc ]; then
		# we ignore -icc when compiling for QT
		TOTO=""
		#CXX=icpc
		#CXXFLAGS='-Wfatal-errors -O3 -xT -ftz -fno-alias -fp-model fast=2'
    fi
done

#PHASE 2 : dispatch command arguments

OSCINC=""
QTDEFS=""
OSCLIB=""
POLY="POLY"
DEPLOY=""
DEF=""
EFFECT=""
NVOICES=-1
CPPFLAGS=""
PLUGIN="0"
IS_SYNTH="0"
IS_MIDI="0"

while [ $1 ]
do
    p=$1

    if [ $p = "-help" ] || [ $p = "-h" ]; then
        echo "faust2juce [-plugin] [-nvoices <num>] [-effect <effect.dsp>] [-midi] [-osc] <file.dsp>"
        echo "Use '-plugin' to produce a PlugIn, otherwise a standalone application is generated"
        echo "Use '-nvoices <num>' to produce a polyphonic self-contained DSP with <num> voices, ready to be used with MIDI or OSC"
        echo "Use '-effect <effect.dsp>' to produce a polyphonic DSP connected to a global output effect, ready to be used with MIDI or OSC"
        echo "Use '-midi' to activate MIDI control"
        echo "Use '-osc' to activate OSC control"
        exit
    fi
    # Only -poly, -midi and -osc available for now
    if [ "$p" = -omp ]; then
        if [[ $CXX == "icpc" ]]; then
            OMP="-openmp"
        else
            OMP="-fopenmp"
        fi
    fi
  
    if [ "$p" = -debug ]; then
    	DEBUG=true
    elif [ $p = "-deploy" ]; then
        DEPLOY="yes"
    elif [ "$p" = -icc ]; then
    	ignore=" "
    elif [ $p = "-nvoices" ]; then
        shift
        NVOICES=$1
    elif [ $p = "-plugin" ]; then
        PLUGIN="1"
    elif [ $p = "-effect" ]; then
        DEF+="POLY2 "
        POLY="POLY2"
        shift
        EFFECT=$1
    elif [ $p = "-midi" ]; then
        DEF+="MIDICTRL "
        IS_MIDI="1"
    elif [ $p = "-osc" ]; then
		 DEF+="OSCCTRL "
		 OSCLIBS="-lOSCFaust"
	elif [ "$p" = "-httpd" ]; then
		DEF+="HTTPCTRL "
		HTTPLIBS="-lHTTPDFaust -lmicrohttpd -lqrencode"
	elif [ "$p" = "-qrcode" ]; then # requires -httpd
		DEF+="QRCODECTRL "
    elif [ ${p:0:1} = "-" ]; then
	    OPTIONS="$OPTIONS $p"
	elif [[ -f "$p" ]]; then
	    FILES="$FILES $p"
	else
	    OPTIONS="$OPTIONS $p"        
	fi

shift

done

#look for polyphonic "nvoices" metadata in the DSP file

grep "declare nvoices" $FILES && IS_SYNTH="1" 2>/dev/null


#-------------------------------------------------------------------
# compile the *.dsp files
#
for p in $FILES; do

    CUR=$(pwd)
    f=$(basename "$p")
	SRCDIR=$(dirname "$p")

    # creates the dir 
    dspName="${f%.dsp}"
    SUB_TYPE=$(echo ${dspName:0:4} | tr [[:upper:]] [[:lower:]])
    rm -rf "$SRCDIR/$dspName"

    if [ $PLUGIN = "1" ]; then
        cp -r "/usr/local/share/faust/juce/plugin" "$SRCDIR/$dspName/"
        # setting pluginCode name to match the dsp
        sed -e "s/SUB_TYPE/$SUB_TYPE/g" "$dspName/plugin.jucer" >> "$dspName/$dspName-temp.jucer"
    else
        cp -r "/usr/local/share/faust/juce/standalone" "$SRCDIR/$dspName/"
        # setting project name to match the dsp
        sed -e "s/ProjectTitle/$dspName/g" "$dspName/standalone.jucer" >> "$dspName/$dspName-temp.jucer"
    fi

    # setting the preprocessing definitions
    sed -e "s/PreProcDef/$DEF/g" "$dspName/$dspName-temp.jucer" >> "$dspName/$dspName-temp1.jucer"
    sed -e "s/APPL_NAME/$dspName/g" "$dspName/$dspName-temp1.jucer" >> "$dspName/$dspName-temp2.jucer"

    # MIDI
    sed -e "s/IS_MIDI/$IS_MIDI/g" "$dspName/$dspName-temp2.jucer" >> "$dspName/$dspName-temp3.jucer"

    # SYNTH
    sed -e "s/IS_SYNTH/$IS_SYNTH/g" "$dspName/$dspName-temp3.jucer" >> "$dspName/$dspName-temp4.jucer"

    if [ $NVOICES -ge 0 ]; then
        sed -e "s/NUM_VOICES/$NVOICES/g" "$dspName/$dspName-temp4.jucer" >> "$dspName/$dspName.jucer"
    else
        cp  "$dspName/$dspName-temp4.jucer" "$dspName/$dspName.jucer"
    fi

    if [ $PLUGIN = "1" ]; then
        rm "$dspName/plugin.jucer"
    else
        rm "$dspName/standalone.jucer"
    fi
    rm "$dspName/$dspName-temp.jucer" "$dspName/$dspName-temp1.jucer"  "$dspName/$dspName-temp2.jucer"
    rm "$dspName/$dspName-temp3.jucer" "$dspName/$dspName-temp4.jucer"

    if [ $PLUGIN = "1" ]; then
        if [ $POLY = "POLY2" ]; then
            faust -i -a $ARCHFILEPLUGIN $OPTION "$SRCDIR/$f" -o "$dspName/PluginEditor.h" || exit
            faust -i -cn dsp_effect -a minimal-effect.cpp "$SRCDIR/$EFFECT" -o "$dspName/dsp_effect.cpp" || exit
        else
            faust -i -a $ARCHFILEPLUGIN $OPTION "$SRCDIR/$f" -o "$dspName/PluginEditor.h" || exit
        fi
    else
        if [ $POLY = "POLY2" ]; then
            faust -i -a $ARCHFILESTANDALONE $OPTION "$SRCDIR/$f" -o "$dspName/MainComponent.h" || exit
            faust -i -cn dsp_effect -a minimal-effect.cpp "$SRCDIR/$EFFECT" -o "$dspName/dsp_effect.cpp" || exit
        else
            faust -i -a $ARCHFILESTANDALONE $OPTION "$SRCDIR/$f" -o "$dspName/MainComponent.h" || exit
        fi
    fi

done


