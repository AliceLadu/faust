<html>
<head>
<title>
Title
</title>

<!-- Our javascript code -->
<script type="text/javascript">

// init() once the page has finished loading.
window.onload = init;

var context;
var processor;
var dsp;
var ui;
var meta;

var inputs;
var outputs;

var source;

//-----------------------------------------------------------------------------
// a handler to send a faust 'set' message
// actually using a 'GET' method
//-----------------------------------------------------------------------------
function makesethandler() 
{
	return function( dest, val) {
		var msg = dest+"?value="+val;
		if (0) $("#trace").html(msg);
		else $.get( dest+"?value="+val );
	};
}

//-----------------------------------------------------------------------------
// a function to build a slider
// a faust slider is a composite object that embeds a label, a 'range' input
// and a 'text' input displaying the slider value
// slider and text value are linked together to reflect the same value.
//-----------------------------------------------------------------------------

//function makeslider(id, orientation, min, max, value, step, sethandler, dest) 

function makeslider(id, orientation, zone, min, max, value, step) 
{
	var slider = document.createElement('input');
	slider.id		= id;
	slider.type		= "range";
	slider.min		= min;
	slider.max		= max;
	slider.value 	= value;
	slider.step 	= step;

	var valId = "v"+id;
	var textval = document.createElement('input');
	textval.id		= valId;
	textval.type	= "text";
	textval.value 	= value;
	textval.size	= 6;

	textval.onchange = function() { 
                //$("#"+id).val(this.value); 
                zone = this.value; 
                //console.log(this.value); 
                console.log(zone);
            };
	slider.onchange  = function() { 
                //$("#"+id).val(this.value); 
                zone = this.value; 
                //console.log(this.value); 
                console.log(zone); 
            };

	slider.fTextValue = textval;
	return slider;
}

//-----------------------------------------------------------------------------
// a push button
//-----------------------------------------------------------------------------
//function makebutton(label, id, sethandler, dest) 
function makebutton(label, id) 
{
	var button = document.createElement('button');
	button.id = id;
	button.type = "button";
	button.innerHTML = label;
	button.value = 1;
	//button.onmousedown = function(){ sethandler(dest, 1); };
	//button.onmouseup = function(){ sethandler(dest, 0); };
	return button;
}

//-----------------------------------------------------------------------------
// a check box
//-----------------------------------------------------------------------------
//function makecheckbox(id, sethandler, dest)
function makecheckbox(id) 
{
	var cbox = document.createElement('input');
	cbox.id		= id;
	cbox.type	= "checkbox";
	cbox.value	= 0;
	//cbox.onchange = function() {this.value = (this.value == 1) ? 0 : 1; sethandler(dest, this.value);};
	return cbox;
}

function makeCol(elt, classname) 
{
	var col = document.createElement('td');
	if (typeof elt == 'object') {
		col.appendChild (elt);
		elt.className = classname;
	}else {
        col.innerHTML = elt;
    }
	if (typeof classname != 'undefined') {
		col.className = classname;
    }
	return col;
}

function JUI()  {

    this.table = document.createElement('table');
	this.row = document.createElement('tr');
    this.counter = 0;
    
    this.init = function() 
    {
        this.table.className = "ui";
        this.table.appendChild(this.row);
        
        var faustui = document.getElementById("FaustUI");
        faustui.appendChild(this.table);
	}
   
    this.openTabBox = function(label) 
    {
        var row = document.createElement('tr');
        //row.appendChild(document.createElement('center'));
        row.appendChild(document.createTextNode(label));
        this.table.appendChild(row);
	}
    
    this.openHorizontalBox = function(label) 
    {
        var row = document.createElement('tr');
        //row.appendChild(document.createElement('center'));
        row.appendChild(document.createTextNode(label));
        this.table.appendChild(row);
	}
    
    this.openVerticalBox = function(label) 
    {
        var row = document.createElement('tr');
        //row.appendChild(document.createElement('center'));
        row.appendChild(document.createTextNode(label));
        this.table.appendChild(row);
	}
    
    this.closeBox = function() 
    {}
    
    this.addButton = function(label, zone) 
    {
        var row = document.createElement('tr');
        var button = makebutton(label, "button" + this.counter++);
        row.appendChild(button);
		this.table.appendChild(row);
	}
    
    this.addCheckButton = function(label, zone) 
    {
        var row = document.createElement('tr');
        var button = makebutton(label, "button" + this.counter++);
        row.appendChild(button);
		this.table.appendChild(row);
	}
    
    this.addVerticalSlider = function(label, zone, init, min, max, step) 
    {
        var row = document.createElement('tr');
        var slider = makeslider("slider" + this.counter++, 'vertical', zone, min, max, init, step);
                          
		//row.appendChild(makeCol (elt.label, "label") );
		//row.appendChild(makeCol (slider), "control" );
		//row.appendChild(makeCol (slider.fTextValue), "value" );
        
        row.appendChild(slider);
		this.table.appendChild(row);
	}
    
    this.addHorizontalSlider = function(label, zone, init, min, max, step) 
    {
        var row = document.createElement('tr');
        var slider = makeslider("slider" + this.counter++, 'vertical', zone, min, max, init, step);
                          
		//row.appendChild(makeCol (elt.label, "label") );
		//row.appendChild(makeCol (slider), "control" );
		//row.appendChild(makeCol (slider.fTextValue), "value" );
        
        row.appendChild(slider);
		this.table.appendChild(row);
	}
    
    this.addNumEntry = function(label, zone, init, min, max, step) 
    {}

    this.addHorizontalBargraph = function(label, zone,  min, max) 
    {}
    
    this.addVerticalBargraph = function(label, zone,  min, max) 
    {}
    
    this.declare = function(zone, key, value) 
    {}
}

function Meta()  {

    this.table = document.createElement('table');
	this.row = document.createElement('tr');
    
    this.init = function() 
    {
        this.table.className = "ui";
        this.table.appendChild(this.row);
        
        var faustui = document.getElementById("FaustMeta");
        faustui.appendChild(this.table);
	}
    
    this.declare = function(key, value) 
    {
        if (key == "name" 
            || key == "version"
            || key == "copyright"
            || key == "author") {
            var row = document.createElement('tr');
            row.appendChild(document.createTextNode(key));
            row.appendChild(document.createElement('td'));
            row.appendChild(document.createTextNode(value));
            this.table.appendChild(row);
        }
	}
}

<<includeIntrinsic>>

<<includeclass>>

<!-- WebAudio API -->

function process(event) 
{
    var count;
    
    if (event.inputBuffer.numberOfChannels < dsp.getNumInputs()) {
        console.log("Incorrect number of input %d instead of %d", event.inputBuffer.numberOfChannels, dsp.getNumInputs());
        return;
    }
    
    if (event.outputBuffer.numberOfChannels < dsp.getNumOutputs()) {
        console.log("Incorrect number of output %d instead of %d", event.outputBuffer.numberOfChannels, dsp.getNumOutputs());
        return;
    }
     
    for (var i = 0; i < dsp.getNumInputs(); i++) {
        inputs[i] = event.inputBuffer.getChannelData(i);
        if (inputs[i] != null) {
            count = inputs[i].length;
        }
    }
    
    for (var i = 0; i < dsp.getNumOutputs(); i++) {
        outputs[i] = event.outputBuffer.getChannelData(i);
        if (outputs[i] != null) {
            count = outputs[i].length;
        }
    }
    
    dsp.compute(count, inputs, outputs);
}

function loadSample(url) 
{
    // Load asynchronously

    var request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";

    request.onload = function() { 
        source.buffer = context.createBuffer(request.response, false);
        source.looping = true;
        source.noteOn(0);
    }

    request.send();
}

function initAudio(buffer_size) 
{
    context = new webkitAudioContext();
    source = context.createBufferSource();
    
    meta = new Meta();
    meta.init();
   
    ui = new JUI();
    ui.init();
    
    dsp = new mydsp();
    dsp.init(context.sampleRate);
    
    dsp.metadata(meta);
    dsp.buildUserInterface(ui);
    
    console.log(context.sampleRate);
    console.log(dsp.getNumInputs());
    console.log(dsp.getNumOutputs());
    
    inputs = new Array(dsp.getNumInputs());
    outputs = new Array(dsp.getNumOutputs());
    
    processor = context.createJavaScriptNode(buffer_size, dsp.getNumInputs(), dsp.getNumOutputs());
    
    source.connect(processor);
     
    processor.onaudioprocess = process;
    processor.connect(context.destination);
    
    loadSample("t1.wav");
}

function init() 
{
    initAudio(4096);
}

</script>
</head>
<body>

<h1><center> Faust process </center></h1>

<center><div id="FaustUI"></center>
<center><div id="FaustMeta"></center>
</div>

</body>
</html>


