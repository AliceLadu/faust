

<div id = "faustsvg">
<script>

var isWebKitAudio = (typeof (webkitAudioContext) !== "undefined");
var audio_context = (isWebKitAudio) ? new webkitAudioContext() : new AudioContext();
var max_polyphony = 16;
var audio_input = null;
var midi_input = [];
var DSP_poly = null;
var SVG = null;

function changeBufferSize(buffer_size)
{
    var new_buffer_size = buffer_size.options[buffer_size.selectedIndex].value;
    console.log(new_buffer_size);
    startNewDSP(SVG, new_buffer_size);
}

// MIDI input handling

function noteOn(channel, noteNumber, velocity)
{
    if (DSP_poly) {
        //console.log("noteOn : %d %d %d", channel, noteNumber, velocity);
        DSP_poly.noteOn(channel, noteNumber, velocity);
    }
}

function noteOff(channel, noteNumber)
{
    if (DSP_poly) {
        //console.log("noteOff : %d %d", channel, noteNumber);
        DSP_poly.noteOff(channel, noteNumber);
    }
}

function pitchWheel(channel, pitchWheel)
{
    console.log("pitchWheel : %d %d", channel, pitchWheel);
}

function controller(channel, ctrl, value)
{
    console.log("control : %d %d %d", channel, ctrl, value);
}

function midiMessageReceived(ev) 
{
    var cmd = ev.data[0] >> 4;
    var channel = ev.data[0] & 0xf;
    var noteNumber = ev.data[1];
    var velocity = ev.data[2];
    
    //console.log(ev);

    if (channel === 9) {
        return;
    } else if (cmd === 8 || ((cmd === 9) && (velocity === 0))) { 
        noteOff(channel, noteNumber);
    } else if (cmd === 9) {
        noteOn(channel, noteNumber, velocity);
    } else if (cmd === 11) {
        //controller(channel, noteNumber, velocity);
    } else if (cmd === 14) {
        //pitchWheel(((velocity * 128.0 + noteNumber)-8192)/8192.0);
    }  
}

function onerrorcallback(error) 
{
     console.log(error);
}

function onsuccesscallback(access) 
{
    access.inputs().forEach(function(input) {
        midi_input.push(input);
        input.onmidimessage = midiMessageReceived;
        console.log(input.name);
    });
}
 
function activateMIDIInput()
{
    if (typeof (navigator.requestMIDIAccess) !== "undefined") {
        navigator.requestMIDIAccess().then(onsuccesscallback, onerrorcallback);
    } else {
        alert("MIDI input cannot be activated, either your browser still does't have it, or you need to explicitly activate it.");
    }
}

// Audio input handling

function activateAudioInput()
{
    if (!navigator.getUserMedia) {
        navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    }
   
    navigator.getUserMedia({audio:true}, getDevice, function(e) {
            alert('Error getting audio input');
            console.log(e);
    });
}

function getDevice(device) 
{
    // Create an AudioNode from the stream.
    audio_input = audio_context.createMediaStreamSource(device);
    
    // Connect it to the destination.
    audio_input.connect(DSP_poly.scriptProcessor);
}

function startDSPAux(svg, buffer_size) 
{
    SVG = svg;
    activateMIDIInput();
    if (DSP_poly) {
        if (audio_input) {
            audio_input.disconnect(DSP_poly.scriptProcessor);
        }
        DSP_poly.stop();
        DSP_poly.destroy();
    }
    DSP_poly = faust.DSP_poly(audio_context, buffer_size, max_polyphony, _f4u$t.update_incremental_object_value);
    DSP_poly.start();
    console.log(DSP_poly.json());
    _f4u$t.make_audio_ui_asm(svg, DSP_poly);
}

function startDSP(svg) 
{
    startDSPAux(svg, 1024);
}

function startNewDSP(svg, buffer_size) 
{
    startDSPAux(svg, buffer_size);
}

// Polyphonic instrument

$('#faustsvg').svg({onLoad: startDSP});

</script>

<P>
<center>
<form method="POST" name="menu" >
  <select name="selectedBuffer" 
    onChange="changeBufferSize(this.form.selectedBuffer)">
    <option value = 256 > 256 </option>
    <option value = 512> 512 </option>
    <option selected value = 1024> 1024 </option>
    <option value = 2048> 2048 </option>
    <option value = 4096> 4096 </option>
    <option value = 8192> 8192 </option>
    <option value = 16384> 16384 </option>
  </select>
</form>
</center>
