

<script>

var isWebKitAudio = (typeof (webkitAudioContext) !== "undefined");
var audio_context = (isWebKitAudio) ? new webkitAudioContext() : new AudioContext();
var audio_input = null;
var DSP = null;
var wasm_module = null;
var faustsvg = null;
var dsp_code = null;

function changeBufferSize(buffer_size)
{
    var new_buffer_size = buffer_size.options[buffer_size.selectedIndex].value;
    console.log(new_buffer_size);
    startNewDSP(new_buffer_size);
}
 
// Audio input handling

function activateAudioInput()
{
    if (!navigator.getUserMedia) {
        navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    }
   
    if (navigator.getUserMedia) {
        navigator.getUserMedia({audio:true}, getDevice, function(e) {
                alert('Error getting audio input');
                console.log(e);
        });
    } else {
        alert('Audio input API not available');
    }
}

function getDevice(device) 
{
    // Create an AudioNode from the stream.
    audio_input = audio_context.createMediaStreamSource(device);
    
    // Connect it to the destination.
    audio_input.connect(DSP.getProcessor());
}

function startDSPAux(module, buffer_size)
{
    console.log("startDSP" + buffer_size);
    console.log(module);
    if (DSP) {
        if (audio_input) {
            audio_input.disconnect(DSP.getProcessor());
        }
        _f4u$t.hard_delete(faustsvg);
        DSP.stop();
        DSP.destroy();
    }
    DSP = faust.DSP(audio_context, module, buffer_size);
    if (DSP.getNumInputs() > 0) {
        activateAudioInput();
    }
    DSP.start();
    console.log(DSP.json());
    console.log(DSP.controls());
    
    // kludge...ideally, this needs to not be part of the imported JS
    _f4u$t.main_loop = function() {}
    
    faustsvg = $('<div />');
    $('body').append(faustsvg);
    var handler = _f4u$t.main(DSP.json(), faustsvg, DSP.setParamValue);
    DSP.setHandler(handler);
}

function instantiate(bytes, imports)
{
    return WebAssembly.compile(bytes).then(m => new WebAssembly.Instance(m, imports));
}

function startDSP() 
{
    var asm2wasm = { // special asm2wasm imports
        "fmod": function(x, y) {
            return x % y;
        },
        "log10": function(x) {
            return window.Math.log(x) / window.Math.log(10);
        }
    };
    
    var importObject = { imports: { print: arg => console.log(arg) } }
    importObject["global.Math"] = window.Math;
    importObject["asm2wasm"] = asm2wasm;
    fetch('DSP.wasm').then(response => response.arrayBuffer())
    .then(bytes => instantiate(bytes, importObject))
    .then(module => { wasm_module = module;  console.log(module); startDSPAux(module, 1024); });
}
function startNewDSP(buffer_size)
{
    startDSPAux(wasm_module, buffer_size);
}

// To activate audio on iOS
window.addEventListener('touchstart', function() {

	// create empty buffer
	var buffer = audio_context.createBuffer(1, 1, 22050);
	var source = audio_context.createBufferSource();
	source.buffer = buffer;

	// connect to output (your speakers)
	source.connect(audio_context.destination);

	// play the file
	source.noteOn(0);

}, false);

// General

$(startDSP);

</script>

<P>
<center>
<form method="POST" name="menu" >
  <select name="selectedBuffer" 
    onChange="changeBufferSize(this.form.selectedBuffer)">
    <option value = 256> 256 </option>
    <option value = 512> 512 </option>
    <option selected value = 1024> 1024 </option>
    <option value = 2048> 2048 </option>
    <option value = 4096> 4096 </option>
    <option value = 8192> 8192 </option>
  </select>
</form>
</center>

