<html>
<head>
<!-- <script src="jquery-1.7.1.min.js" language="javascript"></script>  -->
<script src="http://code.jquery.com/jquery-1.7.1.min.js" language="javascript"></script> 
<title>
Title
</title>

<!-- Our javascript code -->
<script type="text/javascript">

// init() once the page has finished loading.
window.onload = init;

var context;
var processor;
var dsp;
var ui;
var meta;

var inputs;
var outputs;

var source;

//-----------------------------------------------------------------------------
// a function to build a slider
// a faust slider is a composite object that embeds a label, a 'range' input
// and a 'text' input displaying the slider value
// slider and text value are linked together to reflect the same value.
//-----------------------------------------------------------------------------
function makeslider(id, orientation, handler, min, max, value, step) 
{
	var slider = document.createElement('input');
	slider.id		= id;
	slider.type		= "range";
	slider.min		= min;
	slider.max		= max;
	slider.value 	= value;
	slider.step 	= step;

	var valId = "v"+id;
	var textval = document.createElement('input');
	textval.id		= valId;
	textval.type	= "text";
	textval.value 	= value;
	textval.size	= 6;
  
	textval.onchange = function() { $("#"+id).val(this.value); handler(this.value); };
	slider.onchange  = function() { $("#"+valId).val(this.value); handler(this.value); };
	slider.fTextValue = textval;
	return slider;
}

function makenumentry(id, handler, min, max, value, step) 
{
    var valId = "n"+id;
	var textval = document.createElement('input');
	textval.id		= valId;
	textval.type	= "text";
	textval.value 	= value;
	textval.size	= 6;
  
	textval.onchange = function() { $("#"+id).val(this.value); handler(this.value); };
	return textval;
}

//-----------------------------------------------------------------------------
// a push button
//-----------------------------------------------------------------------------
function makebutton(label, id, handler) 
{
	var button = document.createElement('button');
	button.id = id;
	button.type = "button";
	button.innerHTML = label;
	button.value = 1;
	button.onmousedown = function() { handler(1); };
	button.onmouseup = function() { handler(0); };
	return button;
}

//-----------------------------------------------------------------------------
// a check box
//-----------------------------------------------------------------------------
function makecheckbox(id, handler) 
{
	var cbox = document.createElement('input');
	cbox.id		= id;
	cbox.type	= "checkbox";
	cbox.value	= 0;
	cbox.onchange = function() { this.value = (this.value == 1) ? 0 : 1; handler(this.value); };
	return cbox;
}

function makeCol(elt, classname) 
{
	var col = document.createElement('td');
	if (typeof elt == 'object') {
		col.appendChild(elt);
		elt.className = classname;
	}else {
        col.innerHTML = elt;
    }
	if (typeof classname != 'undefined') {
		col.className = classname;
    }
	return col;
}

function JUI()  {

    this.table = document.createElement('table');
	this.row = document.createElement('tr');
    this.counter = 0;
    
    this.init = function() 
    {
        this.table.className = "ui";
        this.table.appendChild(this.row);
        var faustui = document.getElementById("FaustUI");
        faustui.appendChild(this.table);
	}
   
    this.openTabBox = function(label) 
    {
        var row = document.createElement('tr');
        row.appendChild(document.createElement('td'));
        row.appendChild(document.createTextNode(label));
        this.table.appendChild(row);
	}
    
    this.openHorizontalBox = function(label) 
    {
        var row = document.createElement('tr');
        row.appendChild(document.createElement('td'));
        row.appendChild(document.createTextNode(label));
        this.table.appendChild(row);
	}
    
    this.openVerticalBox = function(label) 
    {
        var row = document.createElement('tr');
        row.appendChild(document.createElement('td'));
        row.appendChild(document.createTextNode(label));
        this.table.appendChild(row);
	}
    
    this.closeBox = function() 
    {}
    
    this.addButton = function(label, handler) 
    {
        var row = document.createElement('tr');
        row.appendChild(document.createElement('td'));
        row.appendChild(makebutton(label, "button" + this.counter++, handler));
        row.appendChild(document.createElement('td'));
		this.table.appendChild(row);
	}
    
    this.addCheckButton = function(label, handler) 
    {
        var row = document.createElement('tr');
        row.appendChild(document.createElement('td'));
        row.appendChild(makebutton(label, "button" + this.counter++, handler));
        row.appendChild(document.createElement('td'));
		this.table.appendChild(row);
	}
    
    this.addVerticalSlider = function(label, handler, init, min, max, step) 
    {
        var row = document.createElement('tr');
        var slider = makeslider("slider" + this.counter++, 'vertical', handler, min, max, init, step);
		row.appendChild(makeCol(label, "label"));
		row.appendChild(makeCol(slider), "control");
		row.appendChild(makeCol(slider.fTextValue), "value");
        this.table.appendChild(row);
	}
    
    this.addHorizontalSlider = function(label, handler, init, min, max, step) 
    {
        var row = document.createElement('tr');
        var slider = makeslider("slider" + this.counter++, 'horizontal', handler, min, max, init, step);
		row.appendChild(makeCol(label, "label"));
		row.appendChild(makeCol(slider), "control");
		row.appendChild(makeCol(slider.fTextValue), "value");
        this.table.appendChild(row);
	}
    
    this.addNumEntry = function(label, handler, init, min, max, step) 
    {
        var row = document.createElement('tr');
        row.appendChild(makeCol(label, "label"));
        row.appendChild(document.createElement('td'));
        row.appendChild(makenumentry("numentry" + this.counter++, handler, min, max, init, step));
        row.appendChild(document.createElement('td'));
        this.table.appendChild(row);
    }

    this.addHorizontalBargraph = function(label, handler,  min, max) 
    {}
    
    this.addVerticalBargraph = function(label, handler,  min, max) 
    {}
    
    this.declare = function(handler, key, value) 
    {}
}

function Meta()  {

    this.table = document.createElement('table');
	this.row = document.createElement('tr');
    
    this.init = function() 
    {
        this.table.className = "ui";
        this.table.appendChild(this.row);
        var faustui = document.getElementById("FaustMeta");
        faustui.appendChild(this.table);
	}
    
    this.declare = function(key, value) 
    {
        if (key == "name" 
            || key == "version"
            || key == "copyright"
            || key == "author") {
            var row = document.createElement('tr');
            row.appendChild(document.createTextNode(key));
            row.appendChild(document.createElement('td'));
            row.appendChild(document.createTextNode(value));
            this.table.appendChild(row);
        }
	}
}

<<includeIntrinsic>>

<<includeclass>>

<!-- WebAudio API -->

function process(event) 
{
    var count;
    
    /*
    if (event.inputBuffer.numberOfChannels < dsp.getNumInputs()) {
        console.log("Incorrect number of input %d instead of %d", event.inputBuffer.numberOfChannels, dsp.getNumInputs());
        return;
    }
    */
    
    if (event.outputBuffer.numberOfChannels < dsp.getNumOutputs()) {
        console.log("Incorrect number of output %d instead of %d", event.outputBuffer.numberOfChannels, dsp.getNumOutputs());
        return;
    }
     
    for (var i = 0; i < dsp.getNumInputs(); i++) {
        inputs[i] = event.inputBuffer.getChannelData(i);
        if (inputs[i] != null) {
            count = inputs[i].length;
        }
    }
    
    for (var i = 0; i < dsp.getNumOutputs(); i++) {
        outputs[i] = event.outputBuffer.getChannelData(i);
        if (outputs[i] != null) {
            count = outputs[i].length;
        }
    }
    
    dsp.compute(count, inputs, outputs);
}

function loadSample(url) 
{
    // Load asynchronously

    var request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";

    request.onload = function() { 
        source.buffer = context.createBuffer(request.response, false);
        source.looping = true;
        source.noteOn(0);
    }

    request.send();
}

function initAudio(buffer_size) 
{
    context = new webkitAudioContext();
    
    meta = new Meta();
    meta.init();
   
    ui = new JUI();
    ui.init();
    
    dsp = new mydsp();
    dsp.init(context.sampleRate);
    
    dsp.metadata(meta);
    dsp.buildUserInterface(ui);
    
    console.log(context.sampleRate);
    console.log(dsp.getNumInputs());
    console.log(dsp.getNumOutputs());
    
    inputs = new Array(dsp.getNumInputs());
    outputs = new Array(dsp.getNumOutputs());
    
    processor = context.createJavaScriptNode(buffer_size, dsp.getNumInputs(), dsp.getNumOutputs());
    processor.onaudioprocess = process;
    
    if (dsp.getNumInputs() == 0)  {
        console.log("Faust sound generator");
        processor.connect(context.destination);
    } else {
        console.log("Faust sound processor");
        // Since we don't have input, send a sound file into the processor
        source = context.createBufferSource();
        source.connect(processor);
        processor.connect(context.destination);
        //loadSample("t1.wav");
    }
}

function init() 
{
    initAudio(4096);
}

function playsound()
{
    var url = $("#sound").val();
    loadSample(url);
}

</script>
</head>
<body>

<h1><center> Faust process </center></h1>
<center><div id="FaustMeta"></center> </div>
<p>
<center><div id="FaustUI"></center> </div>


<p>
<p>
<center>
<table>
<tr><td class="sound">Sound file:</td><td> <input type="text" id="sound" size=20 value="t1.wav"/></td></tr>
<tr><td></td><td><button type="button" onclick="playsound()">Play</button></td></tr>
</table>
</center>

</body>
</html>


